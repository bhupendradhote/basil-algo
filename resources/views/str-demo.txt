<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Angel One Dashboard - Strategy & Backtest</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@3.7.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-primary: #0b1220;
            --bg-secondary: #071024;
            --bg-tertiary: #0f1724;
            --text-primary: #cfe6ff;
            --text-secondary: #9fb3cc;
            --text-accent: #b7f5c6;
            --buy-signal: #4caf50;
            --sell-signal: #f44336;
            --neutral: #ff9800;
            --border-color: #333;
        }
        
        body { 
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; 
            margin: 20px; 
            background: var(--bg-primary); 
            color: var(--text-primary);
        }
        
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-section {
            grid-column: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .strategy-section {
            grid-column: 2;
        }
        
        .controls { 
            display:flex; 
            gap:12px; 
            align-items:center; 
            margin-bottom:12px; 
            flex-wrap:wrap; 
        }
        
        label { 
            display:flex; 
            gap:8px; 
            align-items:center; 
        }
        
        select, input, button { 
            padding:8px; 
            border-radius:6px; 
            border:1px solid var(--border-color); 
            background:var(--bg-tertiary); 
            color:var(--text-primary); 
        }
        
        button {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        #chart { 
            width:100%; 
            height:500px; 
            background:var(--bg-secondary); 
            border-radius:8px; 
            padding:8px; 
            position: relative;
        }
        
        .ltp { 
            font-size:28px; 
            font-weight:700; 
            margin-top:8px; 
            color:var(--text-accent); 
        }
        
        .status { 
            font-size:13px; 
            color:var(--text-secondary); 
            margin-top:6px; 
        }
        
        .small { 
            font-size:12px; 
            color:#92b6d6; 
        }
        
        /* Strategy Card Styles */
        .strategy-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .strategy-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .condition {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .condition.met { background: rgba(76, 175, 80, 0.1); border-left: 3px solid var(--buy-signal); }
        .condition.not-met { background: rgba(255, 255, 255, 0.05); border-left: 3px solid #555; }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-indicator.met { background: var(--buy-signal); }
        .status-indicator.not-met { background: #555; }
        
        .signal {
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .signal.buy { background: rgba(76, 175, 80, 0.2); color: var(--buy-signal); }
        .signal.sell { background: rgba(244, 67, 54, 0.2); color: var(--sell-signal); }
        .signal.neutral { background: rgba(255, 152, 0, 0.2); color: var(--neutral); }
        
        /* Backtest Table Styles */
        .backtest-container {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.05);
            max-height: 400px;
            overflow-y: auto;
        }

        .accuracy-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .win-rate {
            color: var(--text-accent);
            font-weight: bold;
            font-size: 18px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            text-align: left;
            color: var(--text-secondary);
            padding: 8px;
            position: sticky;
            top: 0;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        td {
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .profit-win { color: var(--buy-signal); }
        .profit-loss { color: var(--sell-signal); }

        .timeframe-selector {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .timeframe-btn {
            flex: 1;
            padding: 8px;
            text-align: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .timeframe-btn.active {
            background: rgba(76, 175, 80, 0.2);
            border-color: var(--buy-signal);
            color: var(--buy-signal);
        }
        
        .indicator-value {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 12px;
        }
        
        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<h1>ðŸ“ˆ Angel One Algo Dashboard & Backtest</h1>

<div class="controls">
    <div class="control-group">
        <label>
            Timeframe:
            <select id="timeframe">
                <option value="ONE_DAY">Daily (1D)</option>
                <option value="ONE_HOUR">Hourly (1H)</option>
                <option value="FIFTEEN_MINUTE" selected>15 Minute</option>
                <option value="FIVE_MINUTE">5 Minute</option>
            </select>
        </label>
    </div>
    
    <div class="control-group" style="min-width: 420px;">
        <label style="flex:1;">
            Search symbol:
            <input id="symbolSearch" placeholder="Type symbol name (eg RELIANCE)"/>
        </label>
        <label>
            Results:
            <select id="symbolResults" style="min-width:260px"></select>
        </label>
    </div>
    
    <div class="control-group">
        <button id="login">Login (Laravel)</button>
        <button id="analyze">Refresh Analysis</button>
    </div>
</div>

<div class="dashboard-container">
    <div class="chart-section">
        <div>
            <div id="chart"></div>
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <div class="ltp">LTP: <span id="ltp">--</span></div>
                    <div class="status" id="status">Status: idle</div>
                </div>
                <div style="text-align:right; margin-top:10px;">
                    <div class="small">Next Candle: <span id="countdown">--:--</span></div>
                </div>
            </div>
        </div>

        <div class="backtest-container">
            <div class="accuracy-header">
                <div>
                    <div style="color:var(--text-secondary); font-size:12px;">Total Signals</div>
                    <div id="totalSignals" style="font-weight:bold;">0</div>
                </div>
                <div>
                    <div style="color:var(--text-secondary); font-size:12px;">Strategy Accuracy (5-bar hold)</div>
                    <div id="winRate" class="win-rate">0%</div>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Entry</th>
                        <th>Exit (5 bars)</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody id="signalTableBody">
                    <tr><td colspan="5" style="text-align:center;">No data loaded</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="strategy-section">
        <div class="strategy-card">
            <div class="strategy-title">
                Current Condition
                <span id="overallSignal" class="signal neutral">NEUTRAL</span>
            </div>
            
            <div class="timeframe-selector">
                <div class="timeframe-btn active" data-tf="15M">15M</div>
                <div class="timeframe-btn" data-tf="1H">1H</div>
                <div class="timeframe-btn" data-tf="1D">1D</div>
            </div>
            
            <div id="strategyConditions">
                <div class="condition not-met"><span>Loading...</span></div>
            </div>
        </div>
        
        <div class="strategy-card">
            <div class="strategy-title">Current Indicators</div>
            <div id="currentIndicators">
                <div class="indicator-value"><span>EMA 9:</span> <span id="ema9Value">--</span></div>
                <div class="indicator-value"><span>EMA 50:</span> <span id="ema50Value">--</span></div>
                <div class="indicator-value"><span>EMA 200:</span> <span id="ema200Value">--</span></div>
                <div class="indicator-value"><span>Stoch %K:</span> <span id="stochKValue">--</span></div>
                <div class="indicator-value"><span>RSI:</span> <span id="rsiValue">--</span></div>
                <div class="indicator-value"><span>MACD:</span> <span id="macdValue">--</span></div>
            </div>
        </div>
        
        <div class="strategy-card">
            <div class="strategy-title">Strategy Logic Used</div>
            <div class="small" style="line-height:1.5;">
                <p><strong>Buy Signal:</strong><br>Price > EMA 9 & 50<br>+ Stochastic Cross UP</p>
                <p><strong>Sell Signal:</strong><br>Price < EMA 9 & 50<br>+ Stochastic Cross DOWN</p>
                <p style="opacity:0.7; margin-top:5px;">*Table calculates accuracy based on price direction 5 candles after entry.</p>
            </div>
        </div>
    </div>
</div>

<script>
(function(){
    // API endpoints
    const SYMBOLS_API = '/api/symbols';
    const HISTORY_API = '/api/history';
    const LARAVEL_LOGIN_API = '/api/login';
    const WSS_BRIDGE = 'ws://localhost:3001';
    
    // Indicator Calculation Params
    const INDICATOR_PARAMS = {
        EMA_9: 9, EMA_50: 50, EMA_200: 200, EMA_5: 5,
        STOCH_LEN: 14, STOCH_SMOOTH: 3,
        RSI_LEN: 14,
        MACD_FAST: 12, MACD_SLOW: 26, MACD_SIG: 9
    };
    
    // Interval Metadata
    const intervalMeta = {
        FIVE_MINUTE:  {desc: '5 Minute', secs: 300},
        FIFTEEN_MINUTE:{desc: '15 Minute', secs: 900},
        ONE_HOUR:     {desc: '1 Hour', secs: 3600},
        ONE_DAY:      {desc: '1 Day', secs: 86400},
    };
    
    let selectedToken = '2885'; 
    let chart, candleSeries;
    let lastCandle = null;
    let ws = null, jwtToken = null, feedToken = null, reconnectTimeout = null;
    
    // Indicator Data Storage
    let indicatorData = { ema9:[], ema50:[], ema200:[], ema5:[], stoch:[], rsi:[], macd:[], ha:[] };
    let rawCandleData = []; // Store raw for backtesting

    // UI References
    const $timeframe = $('#timeframe');
    const $symbolSearch = $('#symbolSearch');
    const $symbolResults = $('#symbolResults');
    const $status = $('#status');
    const $ltp = $('#ltp');
    const $overallSignal = $('#overallSignal');
    
    // Initialize chart
    function initChart() {
        const container = document.getElementById('chart');
        chart = LightweightCharts.createChart(container, {
            width: container.clientWidth,
            height: 500,
            layout: { backgroundColor: '#071024', textColor: '#cfe6ff' },
            grid: { vertLines: { color: '#101826' }, horzLines: { color: '#101826' } },
            timeScale: { timeVisible: true, secondsVisible: false, borderColor: '#333' },
            rightPriceScale: { borderColor: '#333' }
        });
        
        candleSeries = chart.addCandlestickSeries({ 
            upColor: '#4caf50', downColor: '#f44336', 
            wickUpColor: '#4caf50', wickDownColor: '#f44336', borderVisible: false 
        });
        
        // Add Indicators
        window.ema9Series = chart.addLineSeries({ color: '#ff9800', lineWidth: 1, title: 'EMA9' });
        window.ema50Series = chart.addLineSeries({ color: '#2196f3', lineWidth: 1, title: 'EMA50' });
        
        window.addEventListener('resize', () => chart.applyOptions({ width: container.clientWidth }));
    }
    
    // --- Indicator Maths ---
    function calculateEMA(data, period) {
        const ema = [];
        const k = 2 / (period + 1);
        let sum = 0;
        for(let i=0; i<data.length; i++) {
            if (i < period) {
                sum += data[i].close;
                if(i === period - 1) ema.push({ time: data[i].time, value: sum/period });
            } else {
                let prev = ema[ema.length-1].value;
                ema.push({ time: data[i].time, value: (data[i].close - prev) * k + prev });
            }
        }
        return ema;
    }

    function calculateStoch(data, period=14, smooth=3) {
        let stoch = [];
        for(let i=0; i<data.length; i++) {
            if(i < period - 1) continue;
            let chunk = data.slice(i - period + 1, i + 1);
            let high = Math.max(...chunk.map(c=>c.high));
            let low = Math.min(...chunk.map(c=>c.low));
            let close = data[i].close;
            let k = ((close - low) / (high - low)) * 100 || 50;
            stoch.push({ time: data[i].time, k: k });
        }
        // Smooth K and Calculate D
        let result = [];
        for(let i=0; i<stoch.length; i++) {
            let smoothedK = stoch[i].k;
            if(i >= smooth - 1) {
                let sum = 0;
                for(let j=0; j<smooth; j++) sum += stoch[i-j].k;
                smoothedK = sum/smooth;
            }
            
            let d = smoothedK; // simplified D for initial
            if(result.length >= 2) {
                 // SMA of K for D
                 let prevK1 = result[result.length-1].k;
                 let prevK2 = result[result.length-2].k;
                 d = (smoothedK + prevK1 + prevK2) / 3;
            }
            result.push({ time: stoch[i].time, k: smoothedK, d: d });
        }
        return result;
    }

    function calculateRSI(data, period=14) {
        // Simplified RSI for brevity
        let rsi = [];
        let gains = 0, losses = 0;
        for(let i=1; i<data.length; i++) {
            let diff = data[i].close - data[i-1].close;
            let gain = diff > 0 ? diff : 0;
            let loss = diff < 0 ? Math.abs(diff) : 0;
            
            if(i <= period) {
                gains += gain; losses += loss;
                if(i === period) {
                    let ag = gains/period; let al = losses/period;
                    let rs = ag/al;
                    rsi.push({ time: data[i].time, value: 100 - (100/(1+rs)) });
                }
            } else {
                // smoothed
                let prevRsi = rsi[rsi.length-1]; // not used for calc, need prev Avgs. 
                // Recalculating efficiently would need storing Avgs.
                // Re-doing simple loop for display purposes:
                // Note: Production RSI needs the smoothed averages stored.
                // Using simple RSI array push for now to avoid complexity in this snippet.
                rsi.push({ time: data[i].time, value: 50 }); // Placeholder
            }
        }
        return rsi; 
    }

    // --- Data Processing ---
    async function loadHistory() {
        if (!selectedToken) return;
        setStatus('Loading history...');
        const interval = $timeframe.val();
        
        try {
            const url = new URL(HISTORY_API, window.location.origin);
            url.searchParams.set('symbol', selectedToken);
            url.searchParams.set('interval', interval);
            url.searchParams.set('limit', 500); 
            
            const r = await fetch(url.toString());
            const json = await r.json();
            const candles = json.data || [];
            
            rawCandleData = candles.map(c => ({
                time: Number(c.time), 
                open: Number(c.open), high: Number(c.high), low: Number(c.low), close: Number(c.close)
            }));
            
            if(rawCandleData.length === 0) { setStatus('No Data'); return; }
            
            candleSeries.setData(rawCandleData);
            lastCandle = rawCandleData[rawCandleData.length - 1];
            
            // Calculate Indicators
            indicatorData.ema9 = calculateEMA(rawCandleData, 9);
            indicatorData.ema50 = calculateEMA(rawCandleData, 50);
            indicatorData.ema200 = calculateEMA(rawCandleData, 200);
            indicatorData.ema5 = calculateEMA(rawCandleData, 5);
            indicatorData.stoch = calculateStoch(rawCandleData, 14, 3);
            
            // Update Chart Lines
            window.ema9Series.setData(indicatorData.ema9);
            window.ema50Series.setData(indicatorData.ema50);
            
            setStatus('Data Loaded');
            
            // RUN BACKTEST & SIGNALS
            runBacktest(rawCandleData);
            updateDashboard();

        } catch (err) {
            console.error(err);
            setStatus('Fetch Error');
        }
    }

    // --- ðŸš€ STRATEGY & BACKTEST LOGIC ---
    function runBacktest(data) {
        let signals = [];
        let markers = [];
        
        // Helper to find indicator value by time
        const findVal = (arr, t) => {
            const item = arr.find(x => x.time === t);
            return item ? item.value : null;
        };
        const findStoch = (arr, t) => {
            const item = arr.find(x => x.time === t);
            return item ? item : {k:50, d:50};
        };

        // Loop through data to generate signals
        // Start from index 50 to ensure indicators exist
        for (let i = 50; i < data.length; i++) {
            const candle = data[i];
            const prevCandle = data[i-1];
            const time = candle.time;
            
            const ema9 = findVal(indicatorData.ema9, time);
            const ema50 = findVal(indicatorData.ema50, time);
            const stoch = findStoch(indicatorData.stoch, time);
            const prevStoch = findStoch(indicatorData.stoch, prevCandle.time);

            if(!ema9 || !ema50) continue;

            // Strategy Logic:
            // BUY: Price > EMA9 & EMA50 AND Stochastic K Crosses Over D
            // SELL: Price < EMA9 & EMA50 AND Stochastic K Crosses Under D
            
            const isBuySetup = candle.close > ema9 && candle.close > ema50;
            const isStochBuyCross = prevStoch.k < prevStoch.d && stoch.k > stoch.d && stoch.k < 80; // Not overbought
            
            const isSellSetup = candle.close < ema9 && candle.close < ema50;
            const isStochSellCross = prevStoch.k > prevStoch.d && stoch.k < stoch.d && stoch.k > 20; // Not oversold

            let signalType = null;

            if (isBuySetup && isStochBuyCross) {
                signalType = 'BUY';
            } else if (isSellSetup && isStochSellCross) {
                signalType = 'SELL';
            }

            if (signalType) {
                // Add Chart Marker
                markers.push({
                    time: time,
                    position: signalType === 'BUY' ? 'belowBar' : 'aboveBar',
                    color: signalType === 'BUY' ? '#4caf50' : '#f44336',
                    shape: signalType === 'BUY' ? 'arrowUp' : 'arrowDown',
                    text: signalType === 'BUY' ? 'B' : 'S'
                });

                // Calculate Result (Look ahead 5 bars)
                let exitPrice = null;
                let result = 'pending';
                if (i + 5 < data.length) {
                    exitPrice = data[i+5].close;
                    if (signalType === 'BUY') {
                        result = exitPrice > candle.close ? 'WIN' : 'LOSS';
                    } else {
                        result = exitPrice < candle.close ? 'WIN' : 'LOSS';
                    }
                }

                signals.push({
                    time: time,
                    type: signalType,
                    price: candle.close,
                    exitPrice: exitPrice,
                    result: result
                });
            }
        }

        // 1. Update Chart Markers
        candleSeries.setMarkers(markers);

        // 2. Populate Table
        const $tbody = $('#signalTableBody');
        $tbody.empty();
        
        let wins = 0;
        let completedTrades = 0;

        // Show latest signals first
        signals.reverse().forEach(sig => {
            const dateStr = new Date(sig.time * 1000).toLocaleString('en-GB', {
                month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'
            });
            
            let resultClass = '';
            let resultText = sig.result;
            
            if(sig.result === 'WIN') {
                wins++;
                completedTrades++;
                resultClass = 'profit-win';
            } else if (sig.result === 'LOSS') {
                completedTrades++;
                resultClass = 'profit-loss';
            }

            const row = `
                <tr>
                    <td>${dateStr}</td>
                    <td><span class="signal ${sig.type.toLowerCase()}">${sig.type}</span></td>
                    <td>${sig.price.toFixed(2)}</td>
                    <td>${sig.exitPrice ? sig.exitPrice.toFixed(2) : '-'}</td>
                    <td class="${resultClass}">${resultText}</td>
                </tr>
            `;
            $tbody.append(row);
        });

        // 3. Update Accuracy Stats
        $('#totalSignals').text(signals.length);
        const winRate = completedTrades > 0 ? ((wins / completedTrades) * 100).toFixed(1) : 0;
        $('#winRate').text(winRate + '%');
    }

    // --- Dashboard Updates ---
    function updateDashboard() {
        const last = rawCandleData[rawCandleData.length-1];
        if(!last) return;

        // Update Text Indicators
        const e9 = indicatorData.ema9[indicatorData.ema9.length-1]?.value || 0;
        const e50 = indicatorData.ema50[indicatorData.ema50.length-1]?.value || 0;
        const k = indicatorData.stoch[indicatorData.stoch.length-1]?.k || 0;

        $('#ema9Value').text(e9.toFixed(2));
        $('#ema50Value').text(e50.toFixed(2));
        $('#stochKValue').text(k.toFixed(2));

        // Simple overall signal Logic for current moment
        let signal = "NEUTRAL";
        let sigClass = "neutral";
        
        if (last.close > e9 && last.close > e50 && k > 20 && k < 80) {
            // Check if K just crossed D up? (simplified for dashboard: just check bullish alignment)
             const d = indicatorData.stoch[indicatorData.stoch.length-1]?.d || 0;
             if(k > d) { signal = "BULLISH"; sigClass = "buy"; }
        } else if (last.close < e9 && last.close < e50) {
             const d = indicatorData.stoch[indicatorData.stoch.length-1]?.d || 0;
             if(k < d) { signal = "BEARISH"; sigClass = "sell"; }
        }

        $overallSignal.text(signal).attr('class', 'signal ' + sigClass);
    }

    // --- Interaction ---
    function setStatus(msg) { $status.text('Status: ' + msg); }

    // Symbol Search (Debounce)
    let searchTimeout;
    $symbolSearch.on('input', function() {
        clearTimeout(searchTimeout);
        const q = $(this).val();
        if(q.length < 2) return;
        searchTimeout = setTimeout(async () => {
            const url = `${SYMBOLS_API}?q=${q}`;
            try {
                const r = await fetch(url);
                const d = await r.json();
                $symbolResults.empty();
                (d.data || []).forEach(s => {
                    $symbolResults.append(`<option value="${s.token}">${s.symbol} (${s.token})</option>`);
                });
                if(d.data.length) $symbolResults.val(d.data[0].token).trigger('change');
            } catch(e) { console.error(e); }
        }, 400);
    });

    $symbolResults.on('change', function() {
        selectedToken = $(this).val();
        loadHistory();
    });

    $timeframe.on('change', loadHistory);
    $('#analyze').on('click', loadHistory);
    
    // Timeframe buttons (visual)
    $('.timeframe-btn').on('click', function() {
        $('.timeframe-btn').removeClass('active');
        $(this).addClass('active');
        const tf = $(this).data('tf');
        if(tf === '15M') $timeframe.val('FIFTEEN_MINUTE');
        if(tf === '1H') $timeframe.val('ONE_HOUR');
        if(tf === '1D') $timeframe.val('ONE_DAY');
        loadHistory();
    });

    // Mock Login for UI
    $('#login').on('click', () => {
        setStatus('Logged in (Simulation)');
        // In real app, perform AJAX login here
    });

    // Init
    $(document).ready(() => {
        initChart();
        // Load default if available (simulated)
        // loadHistory(); 
    });

})();
</script>
</body>
</html>